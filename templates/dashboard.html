<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Algo Trading Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        .metric-card { transition: transform 0.2s; }
        .metric-card:hover { transform: translateY(-2px); }
        .status-indicator { width: 12px; height: 12px; border-radius: 50%; display: inline-block; margin-right: 8px; }
        .status-open { background-color: #007bff; }
        .status-closed-win { background-color: #28a745; }
        .status-closed-loss { background-color: #dc3545; }
        .table-responsive { max-height: 400px; overflow-y: auto; }
        .chart-container { height: 400px; }
        .refresh-indicator { color: #6c757d; font-size: 0.8em; }
        .navbar-brand { font-weight: bold; }
    </style>
</head>
<body class="bg-light">
    <nav class="navbar navbar-dark bg-dark">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">
                <i class="fas fa-chart-line"></i> Algorithmic Trading Dashboard
            </span>
            <span class="refresh-indicator" id="lastUpdate">Loading...</span>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <!-- Portfolio Status Row -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card metric-card h-100">
                    <div class="card-body text-center">
                        <h5 class="card-title text-muted">Account Balance</h5>
                        <h3 class="text-primary" id="accountBalance">$0.00</h3>
                        <small class="text-muted">Equity: <span id="equity">$0.00</span></small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card metric-card h-100">
                    <div class="card-body text-center">
                        <h5 class="card-title text-muted">Total P&L</h5>
                        <h3 id="totalPnl">$0.00</h3>
                        <small class="text-muted">Today: <span id="todayPnl">$0.00</span></small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card metric-card h-100">
                    <div class="card-body text-center">
                        <h5 class="card-title text-muted">Open Positions</h5>
                        <h3 class="text-info" id="openPositions">0</h3>
                        <small class="text-muted">Contracts: <span id="openQuantity">0</span></small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card metric-card h-100">
                    <div class="card-body text-center">
                        <h5 class="card-title text-muted">Win Rate</h5>
                        <h3 class="text-success" id="winRate">0%</h3>
                        <small class="text-muted">Total Trades: <span id="totalTrades">0</span></small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Row -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-chart-area"></i> P&L Performance</h5>
                    </div>
                    <div class="card-body">
                        <div id="pnlChart" class="chart-container"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Data Tables Row -->
        <div class="row mb-4">
            <!-- Latest Trades -->
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-history"></i> Latest Trades</h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-sm table-hover mb-0">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Status</th>
                                        <th>Symbol</th>
                                        <th>Dir</th>
                                        <th>Qty</th>
                                        <th>Entry</th>
                                        <th>Exit</th>
                                        <th>P&L</th>
                                        <th>Signal</th>
                                        <th>Modal</th>
                                        <th>Time</th>
                                    </tr>
                                </thead>
                                <tbody id="tradesTableBody">
                                    <tr><td colspan="10" class="text-center">Loading...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Bayesian Statistics -->
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-brain"></i> Bayesian Stats (Top 10)</h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-sm table-hover mb-0">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Bin</th>
                                        <th>Trades</th>
                                        <th>Win%</th>
                                        <th>Mult</th>
                                    </tr>
                                </thead>
                                <tbody id="bayesianTableBody">
                                    <tr><td colspan="4" class="text-center">Loading...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Cluster Analysis Row -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-analytics"></i> Volume Cluster Analysis</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <!-- Thresholds -->
                            <div class="col-md-6">
                                <h6>System Thresholds</h6>
                                <table class="table table-sm">
                                    <tr><td>Volume Threshold:</td><td><span id="volumeThreshold">4.0x</span></td></tr>
                                    <tr><td>Signal Threshold:</td><td><span id="signalThreshold">0.25</span></td></tr>
                                    <tr><td>Long Threshold:</td><td><span id="longThreshold">≤ 0.25</span></td></tr>
                                    <tr><td>Retest Tolerance:</td><td><span id="retestTolerance">0.75 pts</span></td></tr>
                                    <tr><td>Retest Timeout:</td><td><span id="retestTimeout">30 min</span></td></tr>
                                </table>
                            </div>
                            <!-- Recent Stats -->
                            <div class="col-md-6">
                                <h6>Recent Performance (7 days)</h6>
                                <table class="table table-sm">
                                    <tr><td>Total Clusters:</td><td><span id="totalClusters">0</span></td></tr>
                                    <tr><td>Avg Volume Ratio:</td><td><span id="avgVolumeRatio">0.0x</span></td></tr>
                                    <tr><td>Avg Signal Strength:</td><td><span id="avgSignalStrength">0.0</span></td></tr>
                                    <tr><td>Strong Signals:</td><td><span id="strongSignals">0</span></td></tr>
                                </table>
                            </div>
                        </div>
                        
                        <h6 class="mt-3">Recent Clusters</h6>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead class="table-light">
                                    <tr>
                                        <th>Time</th>
                                        <th>Symbol</th>
                                        <th>Volume Ratio</th>
                                        <th>Signal Strength</th>
                                        <th>Modal Position</th>
                                        <th>Direction</th>
                                        <th>Outcome</th>
                                    </tr>
                                </thead>
                                <tbody id="clustersTableBody">
                                    <tr><td colspan="7" class="text-center">Loading...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Dashboard JavaScript
        let refreshInterval;
        
        function formatCurrency(value) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 2
            }).format(value);
        }
        
        function formatPercent(value) {
            return value.toFixed(1) + '%';
        }
        
        function updatePortfolio() {
            fetch('/api/portfolio')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('accountBalance').textContent = formatCurrency(data.account_balance);
                    document.getElementById('equity').textContent = formatCurrency(data.equity);
                    document.getElementById('totalPnl').textContent = formatCurrency(data.total_pnl);
                    document.getElementById('totalPnl').className = data.total_pnl >= 0 ? 'text-success' : 'text-danger';
                    document.getElementById('todayPnl').textContent = formatCurrency(data.today_pnl);
                    document.getElementById('openPositions').textContent = data.open_positions;
                    document.getElementById('openQuantity').textContent = data.open_quantity;
                    document.getElementById('winRate').textContent = formatPercent(data.all_time_win_rate);
                    document.getElementById('totalTrades').textContent = data.total_trades;
                })
                .catch(error => console.error('Error updating portfolio:', error));
        }
        
        function updateTrades() {
            fetch('/api/trades?limit=20')
                .then(response => response.json())
                .then(data => {
                    const tbody = document.getElementById('tradesTableBody');
                    tbody.innerHTML = '';
                    
                    data.forEach(trade => {
                        const row = document.createElement('tr');
                        
                        let statusIndicator = '';
                        if (trade.status === 'open') {
                            statusIndicator = '<span class="status-indicator status-open"></span>Open';
                        } else if (trade.status === 'closed') {
                            if (trade.pnl > 0) {
                                statusIndicator = '<span class="status-indicator status-closed-win"></span>Win';
                            } else {
                                statusIndicator = '<span class="status-indicator status-closed-loss"></span>Loss';
                            }
                        }
                        
                        const pnlClass = trade.pnl > 0 ? 'text-success' : trade.pnl < 0 ? 'text-danger' : '';
                        const pnlText = trade.pnl ? formatCurrency(trade.pnl) : '-';
                        
                        row.innerHTML = `
                            <td>${statusIndicator}</td>
                            <td>${trade.symbol}</td>
                            <td><span class="badge bg-${trade.direction === 'long' ? 'success' : 'danger'}">${trade.direction.toUpperCase()}</span></td>
                            <td>${trade.quantity}</td>
                            <td>$${trade.entry_price.toFixed(2)}</td>
                            <td>${trade.exit_price ? '$' + trade.exit_price.toFixed(2) : '-'}</td>
                            <td class="${pnlClass}">${pnlText}</td>
                            <td>${trade.signal_strength.toFixed(3)}</td>
                            <td>${trade.modal_position.toFixed(3)}</td>
                            <td>${trade.entry_time_formatted}</td>
                        `;
                        tbody.appendChild(row);
                    });
                })
                .catch(error => console.error('Error updating trades:', error));
        }
        
        function updateBayesian() {
            fetch('/api/bayesian')
                .then(response => response.json())
                .then(data => {
                    const tbody = document.getElementById('bayesianTableBody');
                    tbody.innerHTML = '';
                    
                    // Show only top 10 bins with trades
                    const activeBins = data.filter(bin => bin.total_trades > 0)
                                          .sort((a, b) => b.total_trades - a.total_trades)
                                          .slice(0, 10);
                    
                    activeBins.forEach(bin => {
                        const row = document.createElement('tr');
                        const multiplierClass = bin.bayesian_multiplier > 1.5 ? 'text-success' : 
                                              bin.bayesian_multiplier < 0.8 ? 'text-danger' : '';
                        
                        row.innerHTML = `
                            <td>${bin.bin_range}</td>
                            <td>${bin.total_trades}</td>
                            <td>${bin.win_rate_pct.toFixed(1)}%</td>
                            <td class="${multiplierClass}">${bin.bayesian_multiplier.toFixed(2)}x</td>
                        `;
                        tbody.appendChild(row);
                    });
                    
                    if (activeBins.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No trading data yet</td></tr>';
                    }
                })
                .catch(error => console.error('Error updating Bayesian:', error));
        }
        
        function updateClusters() {
            fetch('/api/clusters')
                .then(response => response.json())
                .then(data => {
                    // Update thresholds
                    document.getElementById('volumeThreshold').textContent = data.thresholds.volume_threshold + 'x';
                    document.getElementById('signalThreshold').textContent = data.thresholds.signal_threshold;
                    document.getElementById('longThreshold').textContent = '≤ ' + data.thresholds.long_threshold;
                    document.getElementById('retestTolerance').textContent = data.thresholds.retest_tolerance + ' pts';
                    document.getElementById('retestTimeout').textContent = data.thresholds.retest_timeout + ' min';
                    
                    // Update stats
                    document.getElementById('totalClusters').textContent = data.signal_stats.total_signals || 0;
                    document.getElementById('avgVolumeRatio').textContent = (data.volume_stats.avg_volume_ratio || 0).toFixed(1) + 'x';
                    document.getElementById('avgSignalStrength').textContent = (data.signal_stats.avg_signal_strength || 0).toFixed(3);
                    document.getElementById('strongSignals').textContent = data.signal_stats.strong_signals || 0;
                    
                    // Update recent clusters table
                    const tbody = document.getElementById('clustersTableBody');
                    tbody.innerHTML = '';
                    
                    data.recent_clusters.forEach(cluster => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${cluster.cluster_time_formatted}</td>
                            <td>${cluster.symbol}</td>
                            <td>${cluster.volume_ratio.toFixed(1)}x</td>
                            <td>${cluster.signal_strength.toFixed(3)}</td>
                            <td>${cluster.modal_position.toFixed(3)}</td>
                            <td><span class="badge bg-${cluster.direction === 'long' ? 'success' : 'danger'}">${cluster.direction.toUpperCase()}</span></td>
                            <td><span class="badge bg-${cluster.outcome_class}">${cluster.outcome}</span></td>
                        `;
                        tbody.appendChild(row);
                    });
                    
                    if (data.recent_clusters.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">No recent clusters</td></tr>';
                    }
                })
                .catch(error => console.error('Error updating clusters:', error));
        }
        
        function updatePnLChart() {
            fetch('/api/charts/pnl')
                .then(response => response.json())
                .then(data => {
                    if (data.chart) {
                        const chart = JSON.parse(data.chart);
                        Plotly.newPlot('pnlChart', chart.data, chart.layout, {responsive: true});
                    }
                })
                .catch(error => console.error('Error updating P&L chart:', error));
        }
        
        function updateAll() {
            updatePortfolio();
            updateTrades();
            updateBayesian();
            updateClusters();
            updatePnLChart();
            
            document.getElementById('lastUpdate').textContent = 'Last updated: ' + new Date().toLocaleTimeString();
        }
        
        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            updateAll();
            refreshInterval = setInterval(updateAll, 5000);
        });
        
        // Handle page visibility to pause/resume updates
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                clearInterval(refreshInterval);
            } else {
                updateAll();
                refreshInterval = setInterval(updateAll, 5000);
            }
        });
    </script>
</body>
</html>